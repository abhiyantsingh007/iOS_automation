name: iOS Automation Tests

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  ios-test:
    runs-on: macos-15
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          ls -la apps/

      # ================================================
      # KEY FIX: Proper Simulator Boot with Wait
      # ================================================
      - name: Boot Simulator and Wait Until Ready
        run: |
          echo "=== Available Simulators ==="
          xcrun simctl list devices available | grep -A 5 "iOS 18"
          
          # Get iPhone 16 Pro UDID
          UDID=$(xcrun simctl list devices available | grep "iPhone 16 Pro" | head -1 | awk -F '[()]' '{print $2}')
          echo "Selected UDID: $UDID"
          
          # Shutdown any existing simulator state
          echo "Shutting down any existing simulator..."
          xcrun simctl shutdown "$UDID" 2>/dev/null || true
          sleep 2
          
          # Erase simulator for clean state (optional but recommended for CI)
          echo "Erasing simulator for clean state..."
          xcrun simctl erase "$UDID" 2>/dev/null || true
          sleep 2
          
          # Boot the simulator
          echo "Booting simulator..."
          xcrun simctl boot "$UDID"
          
          # Wait for simulator to fully boot (not just started)
          echo "Waiting for simulator to fully boot..."
          BOOT_TIMEOUT=180
          ELAPSED=0
          
          while [ $ELAPSED -lt $BOOT_TIMEOUT ]; do
            # Check if simulator is in "Booted" state
            STATE=$(xcrun simctl list devices | grep "$UDID" | grep -o "(Booted)" || echo "")
            
            if [ "$STATE" = "(Booted)" ]; then
              # Additional check: wait for SpringBoard (home screen)
              if xcrun simctl spawn "$UDID" launchctl print system 2>/dev/null | grep -q "com.apple.SpringBoard"; then
                echo "✅ Simulator fully booted after ${ELAPSED}s"
                break
              fi
            fi
            
            echo "Waiting for boot... (${ELAPSED}s/${BOOT_TIMEOUT}s)"
            sleep 5
            ELAPSED=$((ELAPSED + 5))
          done
          
          if [ $ELAPSED -ge $BOOT_TIMEOUT ]; then
            echo "❌ Simulator failed to boot within ${BOOT_TIMEOUT}s"
            xcrun simctl list devices | grep "$UDID"
            exit 1
          fi
          
          # Extra wait for system services to stabilize
          echo "Waiting for system services to stabilize..."
          sleep 10
          
          # Get device info
          DEVICE=$(xcrun simctl list devices available | grep "$UDID" | awk -F '(' '{print $1}' | xargs)
          VERSION=$(xcrun simctl list devices | grep -B 10 "$UDID" | grep "iOS" | tail -1 | grep -oE '[0-9]+\.[0-9]+')
          
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV
          
          echo ""
          echo "=== Simulator Ready ==="
          echo "Device: $DEVICE"
          echo "UDID: $UDID"
          echo "iOS: $VERSION"

      # ================================================
      # Verify Simulator Health Before Tests
      # ================================================
      - name: Verify Simulator Health
        run: |
          echo "=== Simulator Status ==="
          xcrun simctl list devices | grep "${{ env.SIMULATOR_UDID }}"
          
          echo ""
          echo "=== Testing Simulator Responsiveness ==="
          # Try to get simulator info
          xcrun simctl getenv "${{ env.SIMULATOR_UDID }}" HOME && echo "✅ Simulator responding"
          
          echo ""
          echo "=== Installing App to Verify ==="
          xcrun simctl install "${{ env.SIMULATOR_UDID }}" "apps/Z Platform-QA.app"
          echo "✅ App installed successfully"

      - name: Start Appium Server
        run: |
          echo "Starting Appium..."
          appium --relaxed-security --log-level info --log-timestamp &
          
          # Wait for Appium
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4723/status > /dev/null; then
              echo "✅ Appium ready"
              curl -s http://127.0.0.1:4723/status
              break
            fi
            sleep 2
          done

      - name: Run Tests
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}
          DEVICE_NAME: ${{ env.DEVICE_NAME }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "=== Running Tests ==="
          echo "Device: $DEVICE_NAME"
          echo "iOS: $PLATFORM_VERSION"
          echo "UDID: $SIMULATOR_UDID"
          
          mvn clean test \
            -Ddevice.name="$DEVICE_NAME" \
            -Dplatform.version="$PLATFORM_VERSION" \
            -Ddevice.udid="$SIMULATOR_UDID" \
            -Dapp.path="$APP_PATH"

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            reports/
