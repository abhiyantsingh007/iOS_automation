name: iOS Automation Tests

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  ios-test:
    runs-on: macos-15  # Use ARM runner for better iOS 18.5 support
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ============================================
      # FIX #1: Select Xcode 16.4 for iOS 18.5 SDK
      # ============================================
      - name: Select Xcode Version
        run: |
          echo "=== Available Xcode Versions ==="
          ls -la /Applications/ | grep Xcode
          
          # Select Xcode 16.4 (includes iOS 18.5 SDK)
          if [ -d "/Applications/Xcode_16.4.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.4.app
          elif [ -d "/Applications/Xcode_16.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.2.app
          else
            sudo xcode-select -s /Applications/Xcode.app
          fi
          
          echo "=== Selected Xcode ==="
          xcode-select -p
          xcodebuild -version

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Appium
        run: |
          npm install -g appium@next
          appium driver install xcuitest

      - name: Unzip App
        run: |
          unzip -o apps/Z-Platform-QA.zip -d apps/
          echo "=== App Contents ==="
          ls -la apps/

      # ============================================
      # FIX #2: Check App's Minimum iOS Requirement
      # ============================================
      - name: Check App Requirements
        run: |
          APP_PATH="apps/Z Platform-QA.app"
          if [ -f "$APP_PATH/Info.plist" ]; then
            echo "=== App Info.plist ==="
            plutil -p "$APP_PATH/Info.plist" | grep -E "MinimumOSVersion|CFBundleIdentifier|CFBundleName"
            
            MIN_VERSION=$(/usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" "$APP_PATH/Info.plist" 2>/dev/null || echo "unknown")
            echo "App requires iOS: $MIN_VERSION"
            echo "APP_MIN_IOS=$MIN_VERSION" >> $GITHUB_ENV
          fi

      # ============================================
      # FIX #3: List Available Runtimes & Devices
      # ============================================
      - name: List Available Simulators
        run: |
          echo "=== Available iOS Runtimes ==="
          xcrun simctl list runtimes | grep -i ios
          
          echo ""
          echo "=== Available iPhone Simulators ==="
          xcrun simctl list devices available | grep -A 50 "iOS"

      # ============================================
      # FIX #4: Find iOS 18.5 Simulator Specifically
      # ============================================
      - name: Boot iOS Simulator
        run: |
          echo "=== Finding iOS 18.5 Simulator ==="
          
          # First, try to find iOS 18.5 runtime
          IOS_185_SECTION=$(xcrun simctl list devices available | grep -A 20 "iOS 18.5" || echo "")
          
          if [ -n "$IOS_185_SECTION" ]; then
            echo "Found iOS 18.5 section"
            # Get first iPhone from iOS 18.5 section
            UDID=$(echo "$IOS_185_SECTION" | grep "iPhone" | head -1 | awk -F '[()]' '{print $2}')
            DEVICE=$(echo "$IOS_185_SECTION" | grep "iPhone" | head -1 | awk -F '(' '{print $1}' | xargs)
            VERSION="18.5"
          else
            echo "iOS 18.5 not found, checking iOS 18.4..."
            IOS_184_SECTION=$(xcrun simctl list devices available | grep -A 20 "iOS 18.4" || echo "")
            
            if [ -n "$IOS_184_SECTION" ]; then
              UDID=$(echo "$IOS_184_SECTION" | grep "iPhone" | head -1 | awk -F '[()]' '{print $2}')
              DEVICE=$(echo "$IOS_184_SECTION" | grep "iPhone" | head -1 | awk -F '(' '{print $1}' | xargs)
              VERSION="18.4"
            else
              echo "ERROR: No suitable iOS simulator found!"
              echo "Available simulators:"
              xcrun simctl list devices available
              exit 1
            fi
          fi
          
          echo "Selected Device: $DEVICE"
          echo "Selected UDID: $UDID"  
          echo "iOS Version: $VERSION"
          
          # Boot the simulator
          xcrun simctl boot "$UDID" || true
          
          # Wait for simulator to be ready
          echo "Waiting for simulator to boot..."
          sleep 10
          
          # Verify simulator is booted
          xcrun simctl list devices | grep "$UDID"
          
          # Export to environment
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE" >> $GITHUB_ENV
          echo "PLATFORM_VERSION=$VERSION" >> $GITHUB_ENV

      # ============================================
      # FIX #5: Validate Compatibility Before Tests
      # ============================================
      - name: Validate App-Simulator Compatibility
        run: |
          echo "=== Compatibility Check ==="
          echo "App requires iOS: ${{ env.APP_MIN_IOS }}"
          echo "Simulator iOS: ${{ env.PLATFORM_VERSION }}"
          
          APP_MIN="${{ env.APP_MIN_IOS }}"
          SIM_VER="${{ env.PLATFORM_VERSION }}"
          
          # Compare versions (simple check)
          if [ "$APP_MIN" = "18.5" ] && [ "$SIM_VER" = "18.4" ]; then
            echo "❌ ERROR: App requires iOS $APP_MIN but simulator has iOS $SIM_VER"
            echo ""
            echo "=== SOLUTIONS ==="
            echo "1. Ask dev team to lower MinimumOSVersion to 18.4 in Xcode"
            echo "2. Install iOS 18.5 runtime: xcrun simctl runtime add 'iOS 18.5'"
            echo "3. Use a different GitHub runner with iOS 18.5 support"
            echo ""
            echo "=== Available Runtimes ==="
            xcrun simctl list runtimes
            exit 1
          fi
          
          echo "✅ Compatibility OK: App ($APP_MIN) <= Simulator ($SIM_VER)"

      - name: Start Appium Server
        run: |
          echo "Starting Appium server..."
          appium --log-level info &
          APPIUM_PID=$!
          echo "APPIUM_PID=$APPIUM_PID" >> $GITHUB_ENV
          
          # Wait for Appium to be ready
          echo "Waiting for Appium to start..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4723/status > /dev/null 2>&1; then
              echo "Appium is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify Appium is running
          curl -s http://127.0.0.1:4723/status | head -20

      # ============================================
      # FIX #6: Pass Correct Parameters to Tests
      # ============================================
      - name: Run Tests
        env:
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
          PLATFORM_VERSION: ${{ env.PLATFORM_VERSION }}
          DEVICE_NAME: ${{ env.DEVICE_NAME }}
          APP_PATH: ${{ github.workspace }}/apps/Z Platform-QA.app
        run: |
          echo "=== Test Configuration ==="
          echo "Device: $DEVICE_NAME"
          echo "UDID: $SIMULATOR_UDID"
          echo "iOS Version: $PLATFORM_VERSION"
          echo "App Path: $APP_PATH"
          echo ""
          
          # Run Maven with explicit parameters
          mvn clean test \
            -Ddevice.name="$DEVICE_NAME" \
            -Dplatform.version="$PLATFORM_VERSION" \
            -Ddevice.udid="$SIMULATOR_UDID" \
            -Dapp.path="$APP_PATH"

      - name: Capture Simulator Logs on Failure
        if: failure()
        run: |
          echo "=== Simulator System Log (last 100 lines) ==="
          xcrun simctl spawn "${{ env.SIMULATOR_UDID }}" log show --last 5m --predicate 'process == "Z Platform-QA"' 2>/dev/null | tail -100 || true

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            target/surefire-reports/
            reports/
          retention-days: 14

      - name: Upload Screenshots on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots
          path: |
            screenshots/
            target/screenshots/
          retention-days: 7
